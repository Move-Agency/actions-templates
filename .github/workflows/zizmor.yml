name: GitHub Actions Security Analysis with zizmor ðŸŒˆ

on:
  workflow_call:
    inputs:
      config:
        default: ''
        type: string
        required: false

jobs:
  zizmor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      ACTION_REPO: 'move-agency/actions-templates'
      ACTION_REF: 'main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Download shared config
        if: inputs.config == 'shared'
        run: |
          curl --fail --remote-name "https://raw.githubusercontent.com/${{ env.ACTION_REPO }}/refs/heads/${{ env.ACTION_REF }}/shared-zizmor.yml"
          
          old_config=""
          if [[ -f "zizmor.yml" ]]; then
            old_config=$(cat "zizmor.yml")
          elif [[ -f ".github/zizmor.yml" ]]; then
            old_config=$(cat ".github/zizmor.yml")
          fi
          
          if [[ -n "$old_config" ]]; then
            echo "Found existing config: $old_config"
            echo "" >> "shared-zizmor.yml"
            echo "$old_config" | tail -n +2 >> "shared-zizmor.yml"
            echo "New config: $(cat "shared-zizmor.yml")"
          fi

      - name: Run zizmor ðŸŒˆ
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0
        with:
          advanced-security: false
          annotations: true
          config: ${{ inputs.config == 'shared' && 'shared-zizmor.yml' || '' }}
